name: Auto Update & Release XrayR

on:
  schedule:
    - cron: '0 4 * * 5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æ£€å‡ºä»£ç  (Checkout Code)
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Go ç¯å¢ƒ (Setup Go)
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          check-latest: true

      - name: 3. æ ¸å¿ƒä¾èµ–æ›´æ–° (Update Dependencies)
        run: |
          echo ">>> å¼€å§‹æ›´æ–°æ ¸å¿ƒä¾èµ–..."
          # å¼ºåˆ¶æ›´æ–° xray-core
          go get -u github.com/xtls/xray-core@latest
          # æ›´æ–°åº•å±‚åŠ å¯†åº“
          go get -u golang.org/x/crypto
          go get -u golang.org/x/net
          echo ">>> ä¾èµ–æ›´æ–°å®Œæˆ"

      # ========================================================
      # ğŸ‘‡ æ–°å¢ï¼šè‡ªåŠ¨ä¿®å¤æ­¥éª¤ (Fix Breaking Changes)
      # ========================================================
      - name: 3.5 è‡ªåŠ¨ä¿®å¤å…¼å®¹æ€§é—®é¢˜ (Fix Compatibility)
        run: |
          echo ">>> æ£€æµ‹åˆ° xray-core ç»“æ„å˜æ›´ï¼Œå¼€å§‹è‡ªåŠ¨ä¿®è¡¥ XrayR ä»£ç ..."
          
          # ä½¿ç”¨ sed å‘½ä»¤åˆ é™¤æ‰€æœ‰å¼•ç”¨äº†å·²ç§»é™¤åŒ…çš„ä»£ç è¡Œ
          # é’ˆå¯¹æŠ¥é”™ï¼štransport/internet/headers/srtp, tls, utp, wechat, wireguard
          
          find cmd -name "*.go" -exec sed -i '/transport\/internet\/headers\/srtp/d' {} +
          find cmd -name "*.go" -exec sed -i '/transport\/internet\/headers\/tls/d' {} +
          find cmd -name "*.go" -exec sed -i '/transport\/internet\/headers\/utp/d' {} +
          find cmd -name "*.go" -exec sed -i '/transport\/internet\/headers\/wechat/d' {} +
          find cmd -name "*.go" -exec sed -i '/transport\/internet\/headers\/wireguard/d' {} +
          
          echo ">>> ä»£ç ä¿®è¡¥å®Œæˆï¼Œä¸å†å¼•ç”¨æ—§ç‰ˆ header åŒ…"

      - name: 4. æ•´ç†ä¾èµ–ä¸æäº¤ (Tidy & Commit)
        id: commit_step
        run: |
          # å†æ¬¡è¿è¡Œ tidy ç¡®ä¿ go.sum æ–‡ä»¶ä¹Ÿæ˜¯å¹²å‡€çš„
          go mod tidy
          
          if [[ -n $(git status -s go.mod go.sum) ]]; then
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git add go.mod go.sum
            git commit -m "chore: auto update dependency and fix breaking changes"
            git push
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: 5. ç¼–è¯‘ XrayR (Build Binary)
        run: |
          echo ">>> å¼€å§‹ç¼–è¯‘..."
          mkdir -p build_assets
          
          echo "æ­£åœ¨ç¼–è¯‘ Linux-AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -ldflags "-s -w" -o build_assets/XrayR-linux-amd64 ./main.go
          
          echo "æ­£åœ¨ç¼–è¯‘ Linux-ARM64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -v -ldflags "-s -w" -o build_assets/XrayR-linux-arm64 ./main.go
          
          cd build_assets
          sha256sum * > sha256sums.txt
          cd ..

      - name: 6. åˆ›å»º Release å‘å¸ƒ (Create Release)
        uses: softprops/action-gh-release@v1
        if: steps.commit_step.outputs.changes_detected == 'true' || github.event_name == 'workflow_dispatch'
        with:
          tag_name: build-${{ github.run_number }}
          name: Auto Build ${{ github.run_number }} (Latest Core Fix)
          body: |
            ## è‡ªåŠ¨æ„å»ºæŠ¥å‘Š
            æ­¤ç‰ˆæœ¬åŒ…å«é’ˆå¯¹æœ€æ–° Xray-Core çš„è‡ªåŠ¨å…¼å®¹æ€§ä¿®å¤ã€‚
            
            ### ğŸ›  ä¿®æ”¹æ—¥å¿—
            - **Xray-Core**: Updated to Latest
            - **Compatibility**: Removed deprecated header imports (srtp, wechat, wireguard, etc.)
            
            ### ğŸ“¦ ä¸‹è½½
            - `XrayR-linux-amd64`: å¸¸è§ VPS
            - `XrayR-linux-arm64`: ARM æ¶æ„
          files: |
            build_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Auto Update & Release XrayR

# è§¦å‘æœºåˆ¶ï¼š
# 1. æ¯å‘¨äº”æ—©ä¸Š 4 ç‚¹è‡ªåŠ¨è¿è¡Œ (é¿å…ä¸šåŠ¡é«˜å³°æœŸ)
# 2. å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡» "Run workflow" æŒ‰é’®è§¦å‘
on:
  schedule:
    - cron: '0 4 * * 5'
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸è„šæœ¬ä¿®æ”¹ä»£ç å¹¶å‘å¸ƒ Release

jobs:
  update-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æ£€å‡ºä»£ç  (Checkout Code)
        uses: actions/checkout@v4

      - name: 2. å®‰è£… Go ç¯å¢ƒ (Setup Go)
        uses: actions/setup-go@v5
        with:
          go-version: '1.23' # ä½¿ç”¨è¾ƒæ–°çš„ Go ç‰ˆæœ¬ä»¥è·å¾—æ€§èƒ½æå‡
          check-latest: true

      - name: 3. æ ¸å¿ƒä¾èµ–æ›´æ–° (Update Dependencies)
        run: |
          echo ">>> å¼€å§‹æ›´æ–°æ ¸å¿ƒä¾èµ–..."
          
          # 1. å¼ºåˆ¶æ›´æ–° xray-core (æ ¸å¿ƒå¼•æ“)
          go get -u github.com/xtls/xray-core@latest
          
          # 2. æ›´æ–°åº•å±‚åŠ å¯†å’Œç½‘ç»œåº“ (ä¿®å¤ HTTP/2 ç­‰åè®®æ¼æ´)
          go get -u golang.org/x/crypto
          go get -u golang.org/x/net
          
          # 3. æ•´ç†å…¶ä»–ä¾èµ– (ç§»é™¤ä¸éœ€è¦çš„ï¼Œä¸‹è½½ç¼ºå¤±çš„)
          go mod tidy
          
          echo ">>> ä¾èµ–æ›´æ–°å®Œæˆ"

      - name: 4. æäº¤ä¾èµ–å˜æ›´ (Commit Changes)
        id: commit_step
        run: |
          # æ£€æŸ¥ go.mod æ˜¯å¦æœ‰å˜åŒ–
          if [[ -n $(git status -s go.mod go.sum) ]]; then
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git add go.mod go.sum
            git commit -m "chore: auto update xray-core and dependencies"
            git push
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo ">>> ä¾èµ–æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: 5. ç¼–è¯‘ XrayR (Build Binary)
        # æ— è®ºæ˜¯å¦æœ‰æ›´æ–°ï¼Œæˆ‘ä»¬éƒ½å°è¯•ç¼–è¯‘ä¸€ä¸‹ï¼Œä»¥ç¡®ä¿å½“å‰ä»£ç æ˜¯å¯ç”¨çš„
        run: |
          echo ">>> å¼€å§‹ç¼–è¯‘..."
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p build_assets
          
          # ç¼–è¯‘ Linux AMD64 (æœ€å¸¸è§çš„ VPS)
          echo "æ­£åœ¨ç¼–è¯‘ Linux-AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -ldflags "-s -w" -o build_assets/XrayR-linux-amd64 ./main.go
          
          # ç¼–è¯‘ Linux ARM64 (é€‚ç”¨äºç”²éª¨æ–‡ ARMã€æ ‘è“æ´¾ç­‰)
          echo "æ­£åœ¨ç¼–è¯‘ Linux-ARM64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -v -ldflags "-s -w" -o build_assets/XrayR-linux-arm64 ./main.go
          
          # ç”Ÿæˆæ–‡ä»¶çš„å“ˆå¸Œå€¼ (ç”¨äºæ ¡éªŒä¸‹è½½æ–‡ä»¶æ˜¯å¦å®Œæ•´)
          cd build_assets
          sha256sum * > sha256sums.txt
          cd ..

      - name: 6. åˆ›å»º Release å‘å¸ƒ (Create Release)
        uses: softprops/action-gh-release@v1
        if: steps.commit_step.outputs.changes_detected == 'true' || github.event_name == 'workflow_dispatch'
        with:
          tag_name: build-${{ github.run_number }}
          name: Auto Build ${{ github.run_number }} (Upstream Sync)
          body: |
            ## è‡ªåŠ¨æ„å»ºæŠ¥å‘Š
            æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
            
            ### ğŸ›¡ å®‰å…¨æ›´æ–°
            - **Xray-Core**: Latest
            - **Crypto/Net Libs**: Updated
            
            ### ğŸ“¦ åŒ…å«æ¶æ„
            - `XrayR-linux-amd64`: é€‚ç”¨äº Intel/AMD CPU çš„ VPS
            - `XrayR-linux-arm64`: é€‚ç”¨äº Oracle ARM / Mac M1 Linux ç­‰
            
            âš ï¸ **æ³¨æ„**: è¯·ä¸‹è½½å¯¹åº”æ¶æ„çš„æ–‡ä»¶ï¼Œé‡å‘½åä¸º `XrayR` å¹¶æ›¿æ¢æœåŠ¡å™¨ä¸Šçš„æ—§æ–‡ä»¶ã€‚
          files: |
            build_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
